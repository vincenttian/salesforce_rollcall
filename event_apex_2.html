<apex:page docType="html-5.0"
  sidebar="false" 
  showheader="false"
  standardStylesheets="false"
  Controller="EventController" 
  applyHtmlTag="false"
  applyBodyTag="false"   
  id="todo"
  >
  <html>
    <head>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <apex:stylesheet value="{!URLFOR($Resource.RollCallAssets, 'style.css')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.RollCallAssets, 'scroll.js')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.d3, 'd3.min.js')}"/>
      <apex:includeScript value="{!$Resource.gauge}"/>

      <title>RollCall</title>
      <!-- CHART IMPLEMENTATION : requires gauge.js -->
      <script>
        var gauges = [];
        function createGauge(name, label, min, max)
        {
            var config = 
            {
                size: 250,
                label: label,
                min: undefined != min ? min : 0,
                max: undefined != max ? max : 100,
                minorTicks: 5
            }

            var range = config.max - config.min;
            config.yellowZones = [{ from: config.min + range*0.75, to: config.min + range*0.9 }];
            config.redZones = [{ from: config.min + range*0.9, to: config.max }];

            gauges[name] = new Gauge(name + "GaugeContainer", config);
            gauges[name].render();
        }

        function createGauges()
        {
            createGauge("test", "Test", 0, {!event.maxCapacity} );
        }

        function updateGauges()
        {
            for (var key in gauges)
            {
                var value = {!event.checkedIn};
                gauges[key].redraw(value);
            }
        }

        function initialize()
        {
            createGauges();
            setInterval(updateGauges, 1000);
        }
        </script>
    </head>
    <body onload="initialize(); line_chart_info();">
      <div id="navbar">
        <div id="navbar_title">
          <p> You are now managing: <br></br> <span class="blue_text">  
            {!event.name}
            </span> 
          </p>
        </div>
        <a class="tab blue_border hover_blue_text" data-section="one" href="#">
          <p> Information </p>
        </a>
        <a class="tab magenta_border hover_magenta_text" data-section="two" href="#">
          <p> Statistics </p>
        </a>
        <a class="tab green_border hover_green_text" data-section="three" href="#">
          <p> Attendees </p>
        </a>
        <apex:outputLink value="{!$Page.checkin}">
          <div class="tab red_border hover_red_text">
            <p> Check In </p>
          </div>
          <apex:param name="event_id" value="{!$CurrentPage.parameters.event_id}"/>
        </apex:outputLink>

        <div id="return" onclick="javascript:window.location='{!$Page.test}';"></div>
      </div>
      <input type='hidden' value='{!$CurrentPage.parameters.event_id}'/> 
      <div id="container">
        <section id="one" class="active">
          <div class="page">
            <div id="event">
              <div class="information">
                <p class="blue_text"> Name: </p>
                <p> {!event.name} </p>
                <p class="blue_text"> Description: </p>
                <p> {!event.description} </p>
                <p class="blue_text"> Date: </p>
                <p> {!event.start} </p>
                <p class="blue_text"> Number Registered: </p>
                <p> {!event.registered} </p>
                <p class="blue_text"> Number Checked In: </p>
                <p> {!event.checkedIn} </p>
              </div>
            </div>
          </div>
        </section>
        <!-- Statistics -->
        <section id="two">
          <div class="page" id="page_two">
            <div id="chart_one"></div>
            <div id="chart_two"></div>
            <div id="chart_three">
                 <!-- CHART IMPLEMENTATION : requires gauge.js -->
                <span id="testGaugeContainer"></span>
            </div>
          </div>
        </section>
        <!-- Attendees -->
        <section id="three">
          <div class="page">
            <div id="attendee_list">
              <apex:repeat value="{!attendees}" var="attendee" id="theRepeat">
                <br> </br>
                <ul>
                  <li>
                    <p> First Name: {!attendee.Contact.Firstname} </p>
                    <p> Last Name: {!attendee.Contact.Lastname} </p>
                    <p> Email : {!attendee.Contact.Email} </p>
                    <p> Company: {!attendee.Contact.Company__c} </p>
                  </li>
                </ul>
              </apex:repeat>
            </div>
          </div>
        </section>
      </div>
    <!-- CHART IMPLEMENTATION: requires data.json -->
    <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: #000;
      shape-rendering: crispEdges;
    }

    .x.axis path {
      display: none;
    }

    .line {
      fill: none;
      stroke: steelblue;
      stroke-width: 1.5px;
    }
    </style>
    <script>
    // var width = 624,
    //     height = 284;

    // var parseTime = d3.time.format("%H:%M:%S").parse;

    // var x = d3.time.scale()
    //     .range([0, width]);

    // var y = d3.scale.linear()
    //     .range([height, 0]);

    // var xAxis = d3.svg.axis()
    //     .scale(x)
    //     .orient("bottom");

    // var yAxis = d3.svg.axis()
    //     .scale(y)
    //     .orient("left");

    // var line = d3.svg.line()
    //     .x(function(d) { return x(d.date); })
    //     .y(function(d) { return y(d.close); });

    // var svg = d3.select("#chart_one").append("svg")
    //     .attr("width", width + 100)
    //     .attr("height", height + 100)
    //   .append("g")
    //     .attr("transform", "translate(" + 50 + "," + 50 + ")");

    var data = {
                  "close": [
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0,
                    0
                  ],
                  "date": [
                    "03:30:00",
                    "03:30:00",
                    "03:32:00",
                    "03:35:00",
                    "03:36:00",
                    "03:38:00",
                    "03:45:00",
                    "03:46:00",
                    "16:00:00"
                  ]
                }
    console.log('data.close2: ' + data.close);
    console.log('data.date2: ' + data.date);

    // data = d3.zip(data.close, data.date).map(function(d) {
    //   close = +d[0];
    //   date = parseTime(d[1]);
    //   return {close: close, date: date};
    // });
    // x.domain(d3.extent(data, function(d) { return d.date; }));
    // y.domain(d3.extent(data, function(d) { return d.close; }));

    // svg.append("g")
    //     .attr("class", "x axis")
    //     .attr("transform", "translate(0," + 284 + ")")
    //     .call(xAxis);

    // svg.append("g")
    //     .attr("class", "y axis")
    //     .call(yAxis);

    // svg.append("path")
    //     .datum(data)
    //     .attr("class", "line")
    //     .attr("d", line);
    </script>
    <script>
    var checked_in = {!event.checkedin};
    var registered = {!event.registered};
    var math = registered - checked_in;
    var dataset = {
      attendance: [math, {!event.checkedIn}],
    };

    var width = 362,
        height = 384,
        radius = Math.min(width, height) / 2;

    var color = d3.scale.ordinal()
        .range(["#98abc5", "#8a89a6"]);

    var pie = d3.layout.pie()
        .sort(null);

    var arc = d3.svg.arc()
        .innerRadius(radius - 100)
        .outerRadius(radius - 50);

    var svg2 = d3.select("#chart_two").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var path2 = svg2.selectAll("path")
        .data(pie(dataset.attendance))
        .enter().append("path")
        .attr("fill", function(d, i) { return color(i); })
        .attr("d", arc);

    // Begin SOQL query for data
    function line_chart_info() {
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.EventController.getCheckedInTimes}',
        '{!event.cid}',
        function(result, event){

            if (event.status) {
              console.log('result: ' + result);
                // Get DOM IDs for HTML and Visualforce elements like this
              var width = 624,
                  height = 284;

              var parseTime = d3.time.format("%H:%M:%S").parse;

              var x = d3.time.scale()
                  .range([0, width]);

              var y = d3.scale.linear()
                  .range([height, 0]);

              var xAxis = d3.svg.axis()
                  .scale(x)
                  .orient("bottom");

              var yAxis = d3.svg.axis()
                  .scale(y)
                  .orient("left");

              var line = d3.svg.line()
                  .x(function(d) { return x(d.date); })
                  .y(function(d) { return y(d.close); });

              var svg = d3.select("#chart_one").append("svg")
                  .attr("width", width + 100)
                  .attr("height", height + 100)
                .append("g")
                  .attr("transform", "translate(" + 50 + "," + 50 + ")");

            // Formatting response to JSON object
            var data = '{"close": "';
            for (var i=0; i<result.length - 1; i++) {
                data += (i + 1) + ",";
            } 
            data += (i+1) + '", "date": " ';
            for (var i=0; i<result.length - 1; i++) {
                temp_date = new Date(result[1]);
                // CHANGE THE DATE FORMAT HERE
                date_format = d3.time.format("%H:%M:%S");
                temp_date = date_format(temp_date);
                data += temp_date + ",";
            } 
            temp_date = new Date(result[result.length-1]);
            temp_date = date_format(temp_date);
            data += temp_date + '"}';
            console.log('data: ' + data);
            
            data = jQuery.parseJSON(data);

            console.log('data.close: ' + data.close);
            console.log('data.date: ' + data.date);

            data = d3.zip(data.close, data.date).map(function(d) {
              close = +d[0];
              date = d[1];
              // console.log('date: ' + date);
              return {close: close, date: date};
            });
            x.domain(d3.extent(data, function(d) { return d.date; }));
            y.domain(d3.extent(data, function(d) { return d.close; }));

            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + 284 + ")")
                .call(xAxis);

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis);

            svg.append("path")
                .datum(data)
                .attr("class", "line")
                .attr("d", line);
                
            } else if (event.type === 'exception') {
                document.getElementById("responseErrors").innerHTML = 
                    event.message + "<br/>\n<pre>" + event.where + "</pre>";
            } else {
                document.getElementById("responseErrors").innerHTML = event.message;
            }
        }, 
        {escape: true}
        );
    }
    </script>
    </body>
  </html>
</apex:page>