<apex:page docType="html-5.0"
sidebar="false" 
showheader="false"
standardStylesheets="false"
Controller="CheckInController" 
applyHtmlTag="false"
applyBodyTag="false"   
id="todo"
>
<html>
<head>
  <!--apex:includeScript value="{!URLFOR($Resource.jayquery, 'jquery/jquery-2.0.3.min.js')}"/-->
  <apex:includeScript value="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"/>
  <apex:includeScript value="{!URLFOR($Resource.RollCallAssets, 'scroll.js')}"/>
  <apex:stylesheet value="https://fonts.googleapis.com/css?family=Open+Sans:600"/>
  <apex:stylesheet value="{!URLFOR($Resource.RollCallAssets, 'style.css')}"/>
  <title>RollCall</title>
</head>
<body>
  <input class='normal' id='event_id' type='hidden' value='{!$CurrentPage.parameters.event_id}'/> 
  <div id="select_event">
    <p> Salesforce Workday </p>          
  </div>
  <div id="container">
   <section id="one" class="active">
    <div class="checkin">
      <p id="checkin_title"> Enter your <span class="blue_text"> email </span> to check in: </p>
      <input class="normal"  type="text" name="email" id="email" onclick='clear_error("checkin_error")'/>
      <p id="checkin_error"> Please enter a valid email </p>
      <input id="submit" type="submit" data-section="two" href="#" onclick="check_in_attendee()" value="Check In">  </input>
    </div>
  </section>
  <!-- Confirmation Page -->
  <section id="two">
    <div class="checkin">
      <div id="confirm_info">
        <p> You are checking in as... </p>
        <div id='error'></div>
        <div >
          <p> Name: <span id="checkin_name" class="blue_text"> </span> </p>
        </div>
        <br></br>
        <div>
          <p> Email: <span id="checkin_email" class="blue_text"> </span> </p>
        </div>
        <br></br>
        <div>
          <p> Company: <span id="checkin_company" class="blue_text"> </span> </p>
        </div>
        <div id="test"> </div>  <!-- A div for injecting tests into -->
      </div>
      <a id="confirm" data-section="three" href="#" onclick="update_placeholders()"> 
        <p> Confirm </p>
      </a>
      <p id="confirm_end"> Otherwise, please <a class="blue_text" data-section="one" href="#"> retry</a> checking in or <a class="blue_text" data-section="four" href="#" onclick="update_placeholders()"> update</a> this information </p>
    </div>
  </section>
  <!-- Successful checkin -->
  <section id="three">
    <div class="checkin">
      <img id="checkin_icon" src="{!URLFOR($Resource.RollCallAssets, 'checkin.svg')}"> </img>
      <p id="checkin_confirmation"> Your attendance has been <span class="blue_text"> recorded! </span> </p>
      <a id="checkin_end" data-section="one" href="#"> 
        <p> Return </p>
      </a>
    </div>
  </section>
  <!-- Update Attendee Information -->
  <section id="four">
    <div class="checkin">
      <div class="column">
        <p class="label"> *First Name: </p>
        <p id="first_error"> Please enter a first name </p>
        <p class="label"> *Last Name: </p>
        <p id="last_error"> Please enter a last name </p>
        <p class="label"> Company: </p>
        <p class="label"> *Email: </p>
      </div>
      <div class="column">
        <input  id="update_firstname" type="text" name="firstname" class="input normal" placeholder="" onclick='clear_error("first_error")'/>
        <input  id="update_lastname" type="text" name="lastname" class="input normal" placeholder="" onclick='clear_error("last_error")'/>
        <input  id="update_company" type="text" name="company" class="input normal" placeholder=""/>
        <input  id="update_email" type="text" name="email" class="input normal" placeholder="" readonly="readonly"/>
      </div>
      <input id="update" type="submit" data-section="three" href="#" onclick="update_attendee()" value="Confirm"> </input>
    </div>
  </section>
  <!-- Haven't registered page -->
  <section id="five">
    <div class="checkin">
      <img class="checkin_icon" src="{!URLFOR($Resource.RollCallAssets, 'help_alt.svg')}"> </img>
      <p id="checkin_confirmation"> Seems like you haven't <span class="blue_text"> registered. </span> </p>
      <a class="checkin_end" data-section="four" href="#" onclick="static_placeholders()"> 
          <p> Register </p>
      </a>
      <p id="register_end"> If you remember registering, please <a class="blue_text" data-section="one" href="#"> retry</a> checking in. </p>
    </div>
  </section>
  <!-- Multiple Logins -->
  <section id="six">
    <div class="checkin">
        <p id="multiple"> </p>
        <div id="multipleAttendees"></div>
        <p id="confirm_end"> If none of these are you then please <a class="blue_text" data-section="one" href="#"> retry</a> </p>
    </div>
  </section>
</div>
</body>

<script>
$(document).ready(function() {
    $('a').on('click', function(event) {
        event.preventDefault();
        var sectionId = $(this).attr("data-section");
        if (sectionId == 'one'){
            $("#email").val(''); 
        }
        $toSlide= $("#container section#"+sectionId);
        $fromSlide= $('.active');
        if (!($toSlide.hasClass("active"))) {  
            $fromSlide.animate({"left":"-100%"},100,'linear')
            $toSlide.animate({"left":"0%"},100,'linear',function() {    
                $fromSlide.css("left","100%");
                $fromSlide.removeClass("active");    
                $toSlide.addClass("active");    
            });
        }
    });
});
</script>

<script type="text/javascript">
    var first_name;
    var last_name;
    var company;
    var name;
    
    var mult_email;

    function clear_error(id) {
        var error = document.getElementById(id);
        error.style.display = 'none';
    }

    function check_in_attendee() {
        // Email Validation
        var email = document.getElementById("email").value;    
        var re = /^(([^<>()[\]\\.,;:\s@\"]+(\.[^<>()[\]\\.,;:\s@\"]+)*)|(\".+\"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/; 
        if (email == '' || re.test(email) == false) {
            console.log('STOPPED! Not a valid email according to regex');
            var error = document.getElementById('checkin_error');
            error.style.display = 'block';
            return;
        }    
        var error = document.getElementById('checkin_error');
        error.style.display = 'none';

        // HANDLES MAX CAPACITY
        // if ({!event.checkedIn} >= {!event.maxCapacity}) {
        //     console.log('TOO BIG');
        // }

        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.CheckInController.check_in_attendee}',
            document.getElementById('event_id').value,
            document.getElementById("email").value,
            function(result, event){
                if (event.status) {
                    if (result.length == 1) { // successfully found match in database !
                        if (result[0].ContactId == null) {
                            var lead = result[0].Lead;
                            name = lead.Name;
                            first_name = lead.FirstName;
                            last_name = lead.LastName;
                            company = lead.Company;
                        } else {
                            var contact = result[0].Contact;
                            name = contact.Name;
                            first_name = contact.FirstName;
                            last_name = contact.LastName;
                            company = contact.Company__c;
                        }
    
                        document.getElementById('error').innerHTML = "<p></p>";
                        document.getElementById("checkin_email").innerHTML = document.getElementById("email").value; 
                        document.getElementById("checkin_name").innerHTML = name; 
                        document.getElementById("checkin_company").innerHTML = company;  
                        setSection($("#container section#"+"#two"), $('.active'));
                    } else if (result.length == 0){ // no match in DB - Register page
                        setSection($("#container section#"+"#five"), $('.active'));
                    } else { // could not find match in database
                        mult_email = document.getElementById("email").value;
                        document.getElementById("multiple").innerHTML = "There seem to be multiple " + mult_email + "'s. Which of these do you want to check in as?";
                        
                        for(var i=0;i<result.length;i++){
                           if (result[i].ContactId == null) {
                                var lead = result[i].Lead;
                                name = lead.Name;
                                first_name = lead.FirstName;
                                last_name = lead.LastName;
                                company = lead.Company;
                            } else {
                                var contact = result[i].Contact;
                                name = contact.Name;
                                first_name = contact.FirstName;
                                last_name = contact.LastName;
                                company = contact.Company__c;
                            }
                            var newA = $("<a class='checkin_end' data-section='two' href='#' onclick='checkInMultiple(\""+ result[i].Id +"\");'><p>" + name + ", " + company + "</p></a>");
                            newA.appendTo("#multipleAttendees");
                            document.getElementById("checkin_email").innerHTML = mult_email; 
                        }
                        setSection($("#container section#"+"#six"), $('.active'));
                    }
                } else if (event.type === 'exception') {
                    // should never go here
                } else {
                    document.getElementById("test").innerHTML +=event.message;
                }
            }, 
        {escape: true}
        );
    }

    function update_attendee() {
        var firstname = document.getElementById("update_firstname").value;
        var lastname = document.getElementById("update_lastname").value;
        var error = document.getElementById('first_error');
        error.style.display = 'none';
        var error = document.getElementById('last_error');
        error.style.display = 'none';
        if (firstname == '' || lastname == '') {
            if (firstname == '' && lastname == '') {
                var error = document.getElementById('first_error');
                error.style.display = 'block';
                var error = document.getElementById('last_error');
                error.style.display = 'block';
            } else if (firstname =='') {
                var error = document.getElementById('first_error');
                error.style.display = 'block';
            } else if (lastname == '') {
                var error = document.getElementById('last_error');
                error.style.display = 'block';
            }
            return;
        }
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.CheckInController.update_attendee}',
            document.getElementById('event_id').value,
            document.getElementById("update_firstname").value,
            document.getElementById("update_lastname").value,
            document.getElementById("update_email").value,
            document.getElementById("update_company").value,
                function(result, event){
                    if (event.status) {
                        setSection($("#container section#"+"#three"), $('.active'));
                    } else if (event.type === 'exception') {
                        document.getElementById("test").innerHTML += event.message + "<br/>\n<pre>" + event.where + "</pre>";
                    } else {
                        document.getElementById("test").innerHTML +=event.message;
                    }
                }, 
            {escape: true}
        );
    }

    function update_placeholders() {
        document.getElementById('update_email').value = document.getElementById("email").value;
        document.getElementById('update_firstname').value = first_name;
        document.getElementById('update_lastname').value = last_name;
        document.getElementById('update_company').value = company;
    }
    
    function static_placeholders() {
        document.getElementById('update_email').value = document.getElementById("email").value;
        document.getElementById('update_firstname').value = "";
        document.getElementById('update_lastname').value = "";
        document.getElementById('update_company').value = "";
    }

    function checkInMultiple(campaignMemberId) {    
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.CheckInController.check_in_multiple}',
            campaignMemberId,
            function(result, event){
                if (event.status) {
                    setSection($("#container section#"+"#three"), $('.active'));
                } else if (event.type === 'exception') {
                    // 
                } else {
                    document.getElementById("test").innerHTML +=event.message;
                }
            }, 
            {escape: true}
        );
    }
</script>
</html>
</apex:page>