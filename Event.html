<apex:page docType="html-5.0"
  sidebar="false" 
  showheader="false"
  standardStylesheets="false"
  Controller="EventController" 
  applyHtmlTag="false"
  applyBodyTag="false"   
  id="todo"
  >
  <html>
    <head>
      <apex:stylesheet value="https://fonts.googleapis.com/css?family=Hammersmith+One"/>
      <script src="//ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js"></script>
      <apex:stylesheet value="{!URLFOR($Resource.RollCallAssets, 'style.css')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.RollCallAssets, 'scroll.js')}"/>
      <apex:includeScript value="{!URLFOR($Resource.scrollfix, 'scrollfix/scrollfix.js')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.d3, 'd3.min.js')}"/>
      <apex:includeScript value="{!URLFOR($Resource.jayquery, 'jquery/jquery-2.0.3.min.js')}"/>
      <apex:includeScript value="{!$Resource.gauge}"/>
      <title>RollCall</title>
      <script>
        var gauges = [];
        function createGauge(name, label, min, max) {
            var config = {
                size: 250,
                label: label,
                min: undefined != min ? min : 0,
                max: undefined != max ? max : 100,
                minorTicks: 5
            }
            var range = config.max - config.min;
            config.greenZones = [{ from: config.min + range*0, to: config.min + range/3 }];
            config.yellowZones = [{ from: config.min + range/3, to: config.min + range*2/3 }];
            config.redZones = [{ from: config.min + range*2/3, to: config.max }];
            gauges[name] = new Gauge(name + "GaugeContainer", config);
            gauges[name].render();        }

        function createGauges() {
            createGauge("test", "Test", 0, {!event.maxCapacity} );
        }

        function updateGauges() {
            for (var key in gauges) {
                var value = {!event.checkedIn};
                gauges[key].redraw(value);
            }
        }

        function initialize() {
            createGauges();
            setInterval(updateGauges, 1000);
        }
        </script>
    </head>
    <body onload="initialize(); line_chart_info();">
      <div id="navbar">
        <div id="navbar_title">
          <p> You are now managing: <br></br> <span class="blue_text">  
            {!event.name}
            </span> 
          </p>
        </div>
        <a class="tab blue_border hover_blue_text" data-section="one" href="#">
          <p> Information </p>
        </a>
        <a class="tab magenta_border hover_magenta_text" data-section="two" href="#">
          <p> Statistics </p>
        </a>
        <a class="tab green_border hover_green_text" data-section="three" href="#" onclick='getAttendees(false);'>
          <p> Attendees </p>
        </a>
        <apex:outputLink value="{!$Page.checkin}">
          <div class="tab red_border hover_red_text">
            <p> Check In </p>
          </div>
          <apex:param name="event_id" value="{!$CurrentPage.parameters.event_id}"/>
        </apex:outputLink>
        <div id="return" onclick="javascript:window.location.href='{!$Page.index}';"></div>
      </div>
      <input type='hidden' value='{!$CurrentPage.parameters.event_id}'/> 
      <div id="container">
        <!-- Event Information -->
        <section id="one" class="active">
          <div class="page" >
            <div id="event">
              <div class="information">
                <p class="blue_text"> Name: </p>
                <p> {!event.name} </p>
                <p class="blue_text"> Description: </p>
                <p> {!event.description} </p>
                <p class="blue_text"> Date: </p>
                <p> {!event.start} </p>
                <p class="blue_text"> Number Registered: </p>
                <p> {!event.registered} </p>
                <p class="blue_text"> Number Checked In: </p>
                <p> {!event.checkedIn} </p>
              </div>
            </div>
          </div>
        </section>
        <!-- Event Statistics -->
        <section id="two">
          <div class="page" id="page_two">
              <div id="chart_one">
                  <p class="chart_title"> Flow </p>
                  <p id="rate"> Rate: 
                    <span class="magenta_text"> 
                      <!-- FILL IN HERE -->
                    </span> People/Minute
                  </p>
              </div>
              <div id="chart_two">
                  <p class="chart_title"> Attendance </p>
                  <p class="chart_info"> Checked In: 
                    <span class="blue_text"> 
                      {!event.checkedin} 
                    </span> 
                    <br></br> 
                    Registered: 
                    <span class="gray_text"> 
                      {!event.registered}
                    </span> 
                  </p>
                  <p id="percentage"> </p>
              </div>
              <div id="chart_three">
                  <p class="chart_title"> Capacity </p>
                  <p class="chart_info"> Checked In: <span class="orange_text"> 100 </span> <br></br> Capacity: <span class="gray_text"> 200 </span> </p>
                  <span id="testGaugeContainer"></span>
              </div>>
          </div>
        </section>
        <!-- Event Attendees -->
        <section id="three">
          <div class="page" style="overflow:auto">
            <div class="information" id="attendee_list">
              <input type="text" id="field" class="input form-control object-search-input" onkeyup="getAttendees(false);" onkeypress="if(event.keyCode == 13){hideKeyboard();} return event.keyCode != 13;" placeholder="Search"/> 
               <ul id="the_list"></ul>
               <button id="search" class="btn btn-info loading hidden" onclick="getAttendees(true);">
                  <span class="glyphicon glyphicon-cloud-download"></span> Show More
                </button> 
            </div>
          </div>
        </section>
      </div>
    <!-- Styling for graphs -->
    <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: #CCC;
    }    
    .line {
      fill: none;
      stroke: #ff009d;
      stroke-width: 3px;
    }   
    .tick {
        display: none;
    }    </style>
    <script>
    // Pie Chart for Attendance
    var checked_in = {!event.checkedin};
    var registered = {!event.registered};
    var math = registered - checked_in;

    document.getElementById('percentage').innerHTML = Math.round(checked_in/registered * 100) + "%"

    var dataset = {
      attendance: [math, {!event.checkedIn}],
    };

    var width = 362,
        height = 384,
        radius = Math.min(width, height) / 2;

    var color = d3.scale.ordinal()
        .range(["#0096ff", "#CCC"]);

    var arc = d3.svg.arc()
        .outerRadius(radius - 75)
        .innerRadius(radius - 100);

    var pie = d3.layout.pie()
        .sort(null);

    var svg2 = d3.select("#chart_two").append("svg")
        .attr("width", width)
        .attr("height", height)
      .append("g")
        .attr("transform", "translate(" + width / 2 + "," + height / 2 + ")");

    var path2 = svg2.selectAll("path")
        .data(pie(dataset.attendance))
        .enter().append("path")
        .attr("fill", function(d, i) { return color(i); })
        .attr("d", arc);
    </script>

    <script>
    // Flow Chart of attendees
    function line_chart_info() {
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.EventController.get_checkedin_times}',
        '{!event.cid}',
        function(result, event){
            if (event.status) {
              console.log('result: ' + result);
                // Get DOM IDs for HTML and Visualforce elements like this
              var width = 624,
                  height = 284;
              var parseTime = d3.time.format("%a %b %e %H:%M:%S %Y").parse;
              var x = d3.time.scale()
                  .range([0, width - 100]);
              var y = d3.scale.linear()
                  .range([height, 0]);
              var xAxis = d3.svg.axis()
                  .scale(x)
                  .orient("bottom");
              var yAxis = d3.svg.axis()
                  .scale(y)
                  .orient("left");
              var line = d3.svg.line()
                  .x(function(d) { return x(d.date); })
                  .y(function(d) { return y(d.close); });
              var svg = d3.select("#chart_one").append("svg")
                  .attr("width", width + 100)
                  .attr("height", height + 100)
                .append("g")
                  .attr("transform", "translate(" + 50 + "," + 50 + ")");
            // Formatting response to JSON object
            var data = '{"close": [';
            for (var i=0; i<result.length - 1; i++) {
                data += (i + 1) + ",";
            } 
            data += (i+1) + '], "date": ["';
            for (var i=0; i<result.length - 1; i++) {
                console.log('date: ' + result[i]);
                temp_date = new Date(result[i]);
                // CHANGE THE DATE FORMAT HERE
                date_format = d3.time.format("%a %b %e %H:%M:%S %Y");
                temp_date = date_format(temp_date);
                data += temp_date + '", "';
            } 
            temp_date = new Date(result[result.length-1]);
            temp_date = date_format(temp_date);
            data += temp_date + '"]}';
            console.log('data: ' + data);
            data = jQuery.parseJSON(data);
            var date_list = [];
            data = d3.zip(data.close, data.date).map(function(d) {
              close = d[0];
              date_format = d3.time.format("%a %b %e %H:%M:%S %Y").parse;
              date = date_format(d[1]);
              return {close: close, date: date};
            });
            x.domain(d3.extent(data, function(d) { 
              return d.date; 
            }));
            y.domain(d3.extent(data, function(d) { 
              return d.close; 
            }));
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + 284 + ")")
                .call(xAxis)
                .style("font-family", "'Hammersmith One', sans-serif");

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .style("font-family", "'Hammersmith One', sans-serif");

            svg.append("path")
                .datum(data)
                .attr("class", "line")
                .attr("d", line);            
            } else if (event.type === 'exception') {
                document.getElementById("responseErrors").innerHTML = event.message + "<br/>\n<pre>" + event.where + "</pre>";
            } else {
                document.getElementById("responseErrors").innerHTML = event.message;
            }
        }, 
        {escape: true}
        );
    }
    </script>

    <script type="text/javascript">
    // 
    var page_offset = 50;
    var page = 0;
    function createListElement(attendee) {
        var element = document.createElement("li")
        var f = document.createElement('p');
        var l = document.createElement('p');
        var e = document.createElement('p');
        var c = document.createElement('p');
        console.log(element);
        f.innerHTML = 'First Name: ' + attendee.FirstName;
        l.innerHTML = 'Last Name: ' + attendee.LastName;
        if (attendee.email) {
            e.innerHTML = 'Email: ' + attendee.Email;
        }
        if (attendee.Company__c) {
            c.innerHTML = 'Company: ' + attendee.Company__c;
        } else if (attendee.Company) {
            c.innerHTML = 'Company: ' + attendee.Company__c;
        }
        element.appendChild(f);
        element.appendChild(l);
        element.appendChild(e);
        element.appendChild(c);
        return element;
    }
    function getAttendees(paginate, searchTerm) {
        var searchName = searchTerm ? searchTerm : document.getElementById("field").value;       
        var offset = 0;
        if(paginate){
            page += 1;
            offset = page*page_offset;
        }
        else{
            page = 0;
        }
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.EventController.attendee_search}',
            '{!event.cid}', searchName, offset, 
            function(result, event){
                var objlist = document.getElementById("the_list");
                var fragment = document.createDocumentFragment();
                if (event.status) {
                    if(!paginate){
                        while (objlist.hasChildNodes()) {
                            objlist.removeChild(objlist.lastChild);
                        }
                    }
                    for (var i = 0; i < result.length; i += 1) {
                        fragment.appendChild(createListElement(result[i]));
                    }
                    if (result.length < 30){
                        $("#showmore").addClass("hidden");
                    } else {
                        $("#showmore").removeClass("hidden");
                    }
                    objlist.appendChild(fragment);
                } else if (event.type === 'exception') {
                    console.log('exception');
                    document.getElementById("responseErrors").innerHTML = 
                        event.message + "<br/>\n<pre>" + event.where + "</pre>";
                } else {
                    console.log('null')
                    document.getElementById("responseErrors").innerHTML = event.message;
                }
            }, 
            {escape: true}
        );
    }
    </script>
    </body>
  </html>
</apex:page>