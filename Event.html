<apex:page docType="html-5.0"
  sidebar="false"
  showheader="false"
  standardStylesheets="false"
  Controller="EventController"
  applyHtmlTag="false"
  applyBodyTag="false"
  id="todo"
  >
  <html>
    <head>
      <meta name="viewport" content="width=device-width, initial-scale=1,  minimum-scale=1, maximum-scale=1, user-scalable=no"/>
      <meta name="apple-mobile-web-app-capable" content="yes" />
      <apex:stylesheet value="https://fonts.googleapis.com/css?family=Open+Sans:600"/>
      <apex:stylesheet value="{!URLFOR($Resource.RollCallAssets, 'style.css')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.RollCallAssets, 'scroll.js')}"/>
      <script type="text/javascript" src="{!URLFOR($Resource.d3, 'd3.min.js')}"/>
      <script type="text/javascript" src="{!$Resource.gauge}"/>

      <apex:includeScript value="{!URLFOR($Resource.jayquery, 'jquery/jquery-2.0.3.min.js')}"/>
      <title>RollCall</title>

      <!-- Styling for graphs -->
    <style>
    .axis path,
    .axis line {
      fill: none;
      stroke: #CCC;
    }
    .line {
      fill: none;
      stroke: #ff009d;
      stroke-width: 3px;
    }
    .y {
        display: none;
    }    </style>

    <!-- Styling and scripting for active tabs -->
    <style>
      .active_tab {
        background: #EEEEEE;
      }
    </style>
    <script>
      function activate(id)
      {
          $(".active_tab").removeClass("active_tab");
          if (id == 1) {
            $("#tab_one").addClass("active_tab");
          } else if (id == 2) {
            $("#tab_two").addClass("active_tab");
          }  else if (id == 3) {
            $("#tab_three").addClass("active_tab");
          } else {
            $("#tab_four").addClass("active_tab");
          }
      }
    </script>
    </head>
    <body onload="maxCapacityCheck()">
      <div id="navbar">
        <div id="navbar_title">
          <p> You are now managing: <br></br> <span class="blue_text">
            {!event.name}
            </span>
          </p>
        </div>
        <a id="tab_one" class="tab blue_border hover_blue_text active_tab" data-section="one" href="#" onclick='activate(1);'>
          <p> Information </p>
        </a>
        <a id="tab_two" class="tab magenta_border hover_magenta_text" data-section="two" href="#" onclick="clearDom();initialize(); line_chart_info(); activate(2);">
          <p> Statistics </p>
        </a>
        <a id="tab_three" class="tab green_border hover_green_text" data-section="three" href="#" onclick='getAttendees(false); activate(3);'>
          <p> Attendees </p>
        </a>
        <div id="checkinLink" onclick='javascript:window.location.href="/apex/checkin?event_id={!event.cId}"; activate(4);'>
          <div id="tab_four" class="tab red_border hover_red_text">
            <p> Check In </p>
          </div>
        </div>
        <div id="return" onclick="javascript:window.location.href='{!$Page.index}';"></div>
      </div>
      <div id="container">
        <!-- Event Information -->
        <section id="one" class="active">
          <div class="page" >
            <div id="event">
              <div class="information">
                <p class="blue_text"> Name: </p>
                <p> {!event.name} </p>
                <p class="blue_text"> Description: </p>
                <p> {!event.description} </p>
                <p class="blue_text"> Date: </p>
                <p> {!event.start} </p>
                <p class="blue_text"> Number Registered: </p>
                <p> {!event.registered} </p>
                <p class="blue_text"> Number Checked In: </p>
                <p> {!event.checkedIn} </p>
                <p class="blue_text"> Max Capacity: </p>
                <p> {!event.maxCapacity} </p>
              </div>
            </div>
          </div>
        </section>
        <!-- Event Statistics -->
        <section id="two">
          <div class="page" id="page_two">
            <p class="chart_title" id="flow_title"> Check-in Flow </p>
              <div id="chart_one">
              </div>
              <div id="chart_two">
                  <p class="chart_title"> Attendance </p>
                  <p class="chart_info"> Checked In:
                    <span class="blue_text" id='pie_checkedin'>

                    </span>
                    <br></br>
                    Registered:
                    <span class="gray_text" id='pie_registered'>

                    </span>
                  </p>
                  <p id="percentage"> </p>
              </div>
              <div id="chart_three">
                  <p class="chart_title"> Capacity </p>
                  <p class="chart_info"> Checked In: <span class="orange_text" id='gauge_checkedin'> </span> <br></br> Capacity: <span id="pie_capacity" class="gray_text"></span> </p>
                  <span id="testGaugeContainer"></span>
              </div>
          </div>
        </section>
        <!-- Event Attendees -->
        <section id="three">
          <div class="page" style="overflow:auto;-webkit-overflow-scrolling: touch;" onscroll='blurrer();'>
            <div class="information" id="attendee_list">
              <input type="text" id="field" name="bar" class="input form-control object-search-input normal" onkeyup="getAttendees(false);" placeholder="Search"/>
              <div>
               <p class="green_text"> <br></br>Attendee List: </p>
                <ul id="the_list"></ul>
               <button id="search" class="btn btn-info loading hidden" onclick="getAttendees(true);">
                  <span class="glyphicon glyphicon-cloud-download"></span> Show More
                </button>
              </div>
            </div>
          </div>
        </section>
      </div>
    </body>
    <script type="text/javascript">
        function blurrer(){
               
               $("#field").blur();
               window.focus();
        }
    </script>
    <script>
        var gauges = [];
        function createGauge(name, label, min, max) {
            var config = {
                size: 245,
                label: label,
                min: undefined != min ? min : 0,
                max: undefined != max ? max : 100,
                minorTicks: 5
            }
            var range = config.max - config.min;
            config.greenZones = [{ from: config.min + range*0, to: config.min + range/3 }];
            config.yellowZones = [{ from: config.min + range/3, to: config.min + range*2/3 }];
            config.redZones = [{ from: config.min + range*2/3, to: config.max }];
            gauges[name] = new Gauge(name + "GaugeContainer", config);
            gauges[name].render();
        }

        function initialize() {
                update_stats();
        }

        // javascript remoting for realtime updates
        function update_stats() {
            Visualforce.remoting.Manager.invokeAction(
                '{!$RemoteAction.EventController.update_stats}',
                '{!event.cid}',
                function(result, event){
                    if (event.status) {

                        $("#chart_two").children("svg").remove();

                        var checked_in = result.checkedIn;
                        var registered = result.registered;
                        var math = registered - checked_in;
                        if (registered == 0) {
                          registered = 1;
                        }

                        if (result.maxCapacity != 'Unlimited'){
                            createGauge("test", "Test", 0, result.maxCapacity );
                              var value = result.checkedIn;
                              gauges["test"].redraw(value);
                        }

                        // Pie Chart
                        document.getElementById('gauge_checkedin').innerHTML = result.checkedIn;
                        document.getElementById('pie_checkedin').innerHTML = result.checkedIn;
                        document.getElementById('pie_registered').innerHTML = result.registered;
                        document.getElementById('pie_capacity').innerHTML = result.maxCapacity;

                        document.getElementById('percentage').innerHTML = Math.round(checked_in/registered * 100) + "%"

                        var data = [ {name: "attended", value: result.checkedIn},
                                {name: "absent", value:  math} ];

                        var width = 362,
                            height = 384,
                            radius = Math.min(width, height) / 2;

                        var chart = d3.select("#chart_two")
                                        .append('svg')
                                        .attr("width", width)
                                        .attr("height", height)
                                       .append("g")
                                        .attr("transform", "translate(" + width / 2 + "," + 96 + ")");

                        var radius = Math.min(width, height) / 2;

                        var color = d3.scale.ordinal()
                            .range(["#0096ff", "#CCC"]);

                        var arc = d3.svg.arc()
                            .outerRadius(radius - 85)
                            .innerRadius(radius - 110);

                        var pie = d3.layout.pie()
                            .sort(null)
                            .startAngle(1.1*Math.PI)
                            .endAngle(3.1*Math.PI)
                            .value(function(d) { return d.value; });


                        var g = chart.selectAll(".arc")
                          .data(pie(data))
                        .enter().append("g")
                          .attr("class", "arc");

                        g.append("path")
                          .style("fill", function(d) { return color(d.data.name); })
                          .style("stroke", "#fff")
                          .style("stroke-width", "3px")
                          .transition().delay(function(d, i) { return i * 500; }).duration(1000)
                          .attrTween('d', function(d) {
                               var i = d3.interpolate(d.startAngle+0.1, d.endAngle);
                               return function(t) {
                                   d.endAngle = i(t);
                                 return arc(d);
                               }
                          });
                    } else if (event.type === 'exception') {
                        // should never go here
                    } else {
                        document.getElementById("test").innerHTML +=event.message;
                    }
                },
            {escape: true}
            );
        }
        </script>
        <script>
    // Flow Chart of attendees
    function line_chart_info() {
        Visualforce.remoting.Manager.invokeAction(
        '{!$RemoteAction.EventController.get_checkedin_times}',
        '{!event.cid}',
        function(result, event){
            if (event.status) {
                // Get DOM IDs for HTML and Visualforce elements like this
              if (result.length == 0){
                  $('#chart_one').append('<p class="chart_info" style="top:150px;">No one has checked in yet</p>');
                   return;
              }

              var width = 624,
                  height = 214;
              var parseTime = d3.time.format("%a %b %e %H:%M:%S %Y").parse;
              var x = d3.time.scale()
                  .range([0, width - 100]);
              var y = d3.scale.linear()
                  .range([height, 0]);
              var xAxis = d3.svg.axis()
                  .scale(x)
                  .ticks(4)
                  .orient("bottom");
              var yAxis = d3.svg.axis()
                  .scale(y)
                  .orient("left");
              var line = d3.svg.line()
                  .x(function(d) { return x(d.date); })
                  .y(function(d) { return y(d.close); });
              var svg = d3.select("#chart_one").append("svg")
                  .attr("width", width + 100)
                  .attr("height", height + 100)
                .append("g")
                  .attr("transform", "translate(" + 50 + "," + 50 + ")");
            // Formatting response to JSON object
            var data = '{"close": [';
            for (var i=0; i<result.length - 1; i++) {
                data += (i + 1) + ",";
            }
            data += (i+1) + '], "date": ["';
            for (var i=0; i<result.length - 1; i++) {
                temp_date = new Date(result[i]);
                // CHANGE THE DATE FORMAT HERE
                date_format = d3.time.format("%a %b %e %H:%M:%S %Y");
                temp_date = date_format(temp_date);
                data += temp_date + '", "';
            }
            temp_date = new Date(result[result.length-1]);
            temp_date = date_format(temp_date);
            data += temp_date + '"]}';
            data = jQuery.parseJSON(data);
            var date_list = [];
            data = d3.zip(data.close, data.date).map(function(d) {
              close = d[0];
              date_format = d3.time.format("%a %b %e %H:%M:%S %Y").parse;
              date = date_format(d[1]);
              return {close: close, date: date};
            });
            x.domain(d3.extent(data, function(d) {
              return d.date;
            }));
            y.domain(d3.extent(data, function(d) {
              return d.close;
            }));
            svg.append("g")
                .attr("class", "x axis")
                .attr("transform", "translate(0," + 214 + ")")
                .call(xAxis)
                .style("font-family", "'Hammersmith One', sans-serif");

            svg.append("g")
                .attr("class", "y axis")
                .call(yAxis)
                .style("font-family", "'Hammersmith One', sans-serif");

            svg.append("path")
                .datum(data)
                .attr("class", "line")
                .attr("d", line);
            } else if (event.type === 'exception') {
                document.getElementById("responseErrors").innerHTML = event.message + "<br/>\n<pre>" + event.where + "</pre>";
            } else {
                document.getElementById("responseErrors").innerHTML = event.message;
            }
        },
        {escape: true}
        );
    }
    </script>

    <script type="text/javascript">

    var page_offset = 50;
    var page = 0;
    function createListElement(attendee) {
        var element = document.createElement("li");
        var f = document.createElement('p');
        var e = document.createElement('p');
        f.innerHTML = attendee.Name;
        if (attendee.Email) {
            e.innerHTML = attendee.Email;
        }
        if (attendee.Company__c) {
            f.innerHTML += ', ' + attendee.Company__c;
        } else if (attendee.Company) {
            f.innerHTML += ', ' + attendee.Company;
        }
        element.appendChild(f);
        element.appendChild(e);
        return element;
    }
    function getAttendees(paginate, searchTerm) {
        var searchName = searchTerm ? searchTerm : document.getElementById("field").value;
        var offset = 0;
        if(paginate){
            page += 1;
            offset = page*page_offset;
        }
        else{
            page = 0;
        }
        Visualforce.remoting.Manager.invokeAction(
            '{!$RemoteAction.EventController.attendee_search}',
            '{!event.cid}', searchName, offset,
            function(result, event){
                var objlist = document.getElementById("the_list");
                var fragment = document.createDocumentFragment();
                if (event.status) {
                    if(!paginate){
                        while (objlist.hasChildNodes()) {
                            objlist.removeChild(objlist.lastChild);
                        }
                    }
                    for (var i = 0; i < result.length; i += 1) {
                        fragment.appendChild(createListElement(result[i]));
                    }
                    if (result.length < 50){
                        document.getElementById("search").hidden='hidden';
                    } else {
                        document.getElementById("search").hidden='';
                    }
                    objlist.appendChild(fragment);
                } else if (event.type === 'exception') {
                    document.getElementById("responseErrors").innerHTML =
                        event.message + "<br/>\n<pre>" + event.where + "</pre>";
                } else {
                    document.getElementById("responseErrors").innerHTML = event.message;
                }
            },
            {escape: true}
        );
    }

    function clearDom() {
        document.getElementById("chart_one").innerHTML ="";
        document.getElementById("testGaugeContainer").innerHTML = "";
    }

    function maxCapacityCheck() {
        var maxc = {!event.maxCapacity};
        var checkins = {!event.checkedIn};
        if (checkins >= maxc) {
            $('#checkinLink').replaceWith('<div id="checkinLink">');
        }
    }
    </script>
  </html>
</apex:page>
